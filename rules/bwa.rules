# vim: syntax=python tabstop=4 expandtab
# coding: utf-8
rule bwa_index:
    input:
        "{prefix}.fasta"
    output:
        touch("{prefix}.bwa.index")
    log:
        "{prefix}.bwa.index.log"
    shell:
        "command time -f 'RES:%e\\t%M\\t%P' "
        "./bin/bwa index -a bwtsw -p {output} {input} > {log}  2>&1 "


rule bwamem_map_se:
    input:
        idx="{prefix}/{reference}.bwa.index",
        fq="{prefix}/{reads}.fastq"
    wildcard_constraints:
        config="[a-zA-Z0-9_]+"
    output:
        "{prefix}/{reads}.{reference}.bwa_{config}.bam"
    log:
        "{prefix}/{reads}.{reference}.bwa_{config}.bam.log"
    threads:
        config.get("threads", 1)
    params:
        lambda wildcards: config["mappers"]["bwa_" + wildcards.config]
    shell:
        "command time -f 'RES:%e\\t%M\\t%P' "
        "./bin/bwa mem -t {threads} {params} {input.idx} {input.fq} "
        "-R '@RG\\tID:none\\tSM:none' 2> {log} | "
        "./bin/samtools view -@ {threads} -bS - > {output} "

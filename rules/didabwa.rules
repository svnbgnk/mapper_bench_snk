# vim: syntax=python tabstop=4 expandtab
# coding: utf-8
rule didabwa_index_fm:
    input:
        "{prefix}.fasta"
    output:
        "{prefix}.didabwa.index.log"
    params:
        outdir="{prefix}.didabwa.dir/",
        num_threads=config["num_threads"],
        num_bins=config["num_bins"][0]
    shell:
        "ulimit -n $(({params.num_bins} * 2)); "
        " mkdir -p {params.outdir}; cd {params.outdir}; "
        "command time -f 'RES:%e\\t%M\\t%P' "
        "sh -c '../../bin/prt --partition {params.num_bins} ../../{input} && "
        "seq {params.num_bins} | xargs -P {params.num_threads} -I {{}} "
        "sh -c \" if [ -f mref-{{}}.fa ]; then ../../bin/bwa index mref-{{}}.fa > bwa_index_{{}}.out 2>&1; else echo NO_FILE: mref-{{}}.fa; fi\" '  >> ../../{output} 2>&1"

rule didabwa_index_fm_update:
    input:
        "{prefix}_taxo_1024_up/ref_up_1024"
    output:
        "{prefix}.didabwa.index_up.log"
    params:
        idir="{prefix}_taxo_1024_up/",
        num_threads=config["num_threads"],
        tmp_dir="{prefix}_tmp_didabwa_dir/"
    shell:
        "mkdir -p {params.tmp_dir};  "
        "export num_part=`ls {params.idir}*.fasta|wc -l` ;"
        "cat {params.idir}*.fasta > {params.tmp_dir}dida_update.fasta; "
        "cd {params.tmp_dir}; "
        "command time -f 'RES:%e\\t%M\\t%P' "
        "sh -c '../../bin/prt --partition ${{num_part}} dida_update.fasta && "
        "seq ${{num_part}} | xargs -P {params.num_threads} -I {{}} "
        "sh -c \" if [ -f mref-{{}}.fa ]; then ../../bin/bwa index mref-{{}}.fa > bwa_index_{{}}.out 2>&1; else echo NO_FILE: mref-{{}}.fa; fi\" '  >> ../../{output} 2>&1 ; "
        "cd ../../; rm -r {params.tmp_dir}; "


rule didabwa_map_se:
    input:
        log="{prefix}/{reference}.didabwa.index.log",
        read="{prefix}/{reads}.fastq"
    wildcard_constraints:
        config="[a-zA-Z0-9_]+",
        num_bins="[0-9]+"
    output:
        "{prefix}/{reads}.{reference}.didabwa_{config}.bam"
    log:
        "{prefix}/{reads}.{reference}.didabwa_{config}.log"
    params:
        num_bins=config["num_bins"][0],
        num_threads=config["num_threads"],
        index_dir="{prefix}/{reference}.didabwa.dir/",
        misc=lambda wildcards: config["mappers"]["didabwa_" + wildcards.config]
    shell:
        "ulimit -n $(({params.num_bins} * 2)); "
        "cd {params.index_dir}; "
        "echo `realpath ../../{input.read}` > reads.in; "
        "command time -f 'RES:%e\\t%M\\t%P' "
        "sh -c '../../bin/dsp --partition {params.num_bins} {params.misc} reads.in && "
        "seq {params.num_bins} | xargs -P 8 -I {{}} sh -c \" if [ -f mref-{{}}.fa ]; then ../../bin/bwa mem -o aln-{{}}.sam mref-{{}}.fa mreads-{{}}.fastq > bwa_mem_{{}}.out 2>&1; rm -r aln-{{}}.sam; else echo NO_FILE: mref-{{}}.fa; fi\" && "
        # "../../bin/mrg --partition {params.num_bins} --aligner bwa --mode fast '  > ../../{log} 2>&1 ;  "
        # "../../bin/samtools view -@ {params.num_threads} -bS -F 4 aln.sam > ../../{output}; "

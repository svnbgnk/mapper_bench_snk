# vim: syntax=python tabstop=4 expandtab
# coding: utf-8
from snakemake.remote.FTP import RemoteProvider as FTPRemoteProvider
FTP = FTPRemoteProvider()

rule refs_download_bins:
    wildcard_constraints:
        meth="[taxoCKKTAXOckk]+",
        num_bins="\d+",
        reference="[a-zA-Z0-9\_]+"
    input:
        lambda wildcards: FTP.remote(config["genbank"][wildcards.reference + "_" + wildcards.meth + "_" + wildcards.num_bins],
                                     insecure=True, keep_local=False)
    output:
        touch("{prefix}/{reference}_{meth}_{num_bins}/ref_{num_bins}")
    params:
        num_bins="{num_bins}",
        in_dir="{reference}_{meth}_{num_bins}/",
        out_dir="{prefix}/{reference}_{meth}_{num_bins}/"
    shell:
        "tar -zxvf {input}; "
        "seq 0 $(({params.num_bins}-1)) | xargs -P 8 -I {{}} "
        "sh -c \" cat {params.in_dir}{{}}.fasta | sed -e '/^>/! s/\([^ACGTacgt]\)/N/g; s/ .*//g' > {params.out_dir}{{}}.fasta\"; "
#        "rm -rf {params.in_dir} ; "

rule refs_download:
    wildcard_constraints:
        meth="[taxoCKKTAXOckk]+",
        num_bins="\d+",
        reference="[a-zA-Z0-9\_]+"
    input:
        "{prefix}/{reference}_" + config["bin_methods"][0] + "_" + config["num_bins"][0] + "/ref_" + config["num_bins"][0]
    output:
        "{prefix}/{reference}.fasta"
    params:
        num_bins=config["num_bins"][0],
        in_dir="{prefix}/{reference}_" + config["bin_methods"][0] + "_" + config["num_bins"][0] + "/"
    shell:
        "touch {output}; rm {output}; "
        "seq 0 $(({params.num_bins}-1)) | xargs -I {{}} sh -c \" cat {params.in_dir}{{}}.fasta >> {output}; \"; "


rule refs_update_download_bins:
    wildcard_constraints:
        meth="[taxoCKKTAXOckk]+",
        num_bins="\d+",
        reference="[a-zA-Z0-9\_]+"
    input:
        lambda wildcards: FTP.remote(config["genbank"][wildcards.reference + "_" + wildcards.meth + "_" + wildcards.num_bins + "_up" ],
                                     insecure=True, keep_local=False)
    output:
        touch("{prefix}/{reference}_{meth}_{num_bins}_up/ref_up_{num_bins}")
    params:
        num_bins="{num_bins}",
        in_dir="{reference}_{meth}_{num_bins}_up/",
        out_dir="{prefix}/{reference}_{meth}_{num_bins}_up/"
    shell:
        "tar -zxvf {input}; "
        "ls {params.in_dir} | xargs -P 8 -I {{}} "
        "sh -c \" cat {params.in_dir}{{}} | sed -e '/^>/! s/\([^ACGTacgt]\)/N/g; s/ .*//g' > {params.out_dir}{{}}; \"; "
#        "rm -rf {params.in_dir}; "
